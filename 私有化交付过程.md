# 私有化交付过程

## 1.服务打包：

登陆机器测试机器：10.142.48.169

cd /data1/data/pd/   进行打包服务

报错：整体打包问题  YAML file for ansible_mirrors does not exist.  需要重装ansible_mirrors

## 执行 ./pack_service.sh  all 打包服务为文件(可以选择单个服务)

```
[root@HOST-10-142-48-169 pd]# ./pack_service.sh all
Debug: Checking directory resource/ansible_rpm
Packaging ansible_rpm (version: 1.0)...
Created ansible_rpm-1.0.tar.gz
Debug: Checking directory resource/bind9
Packaging bind9 (version: 1.0)...
Created bind9-1.0.tar.gz
Debug: Checking directory resource/containerd
Packaging containerd (version: 1.0)...
Created containerd-1.0.tar.gz
Debug: Checking directory resource/dcos
Packaging dcos (version: 1.0)...
Created dcos-1.0.tar.gz
Debug: Checking directory resource/jumpserver
Packaging jumpserver (version: 1.0)...
Created jumpserver-1.0.tar.gz
Debug: Checking directory resource/mirrors
Packaging mirrors (version: 1.0)...
Created mirrors-1.0.tar.gz
Debug: Checking directory resource/n9e
Packaging n9e (version: 1.0)...
Created n9e-1.0.tar.gz
Debug: Checking directory resource/ntp
Packaging ntp (version: 1.0)...
Created ntp-1.0.tar.gz
Debug: Checking directory resource/openldap
Packaging openldap (version: 1.0)...
Created openldap-1.0.tar.gz
Debug: Checking directory resource/opensearch
Packaging opensearch (version: 1.0)...
Created opensearch-1.0.tar.gz
Debug: Checking directory resource/repos
Packaging repos (version: 1.0)...
Created repos-1.0.tar.gz
Debug: Checking directory resource/zabbix
Packaging zabbix (version: 1.0)...
Created zabbix-1.0.tar.gz
```

## 在执行整体服务打包 ./final_pack.sh all  打包服务为文件(可以选择单个服务)

```sh
[root@HOST-10-142-48-169 pd]# ./final_pack.sh all
Creating final_packages/pd-20241018132459.tar.gz...
Generating install.sh...
Adding packages/ansible_rpm-1.0.tar.gz to the final package...
Adding yamls/ansible_ansible_rpm.yaml to the final package...
Adding packages/bind9-1.0.tar.gz to the final package...
Adding yamls/ansible_bind9.yaml to the final package...
Adding packages/containerd-1.0.tar.gz to the final package...
Adding yamls/ansible_containerd.yaml to the final package...
Adding packages/dcos-1.0.tar.gz to the final package...
Adding yamls/ansible_dcos.yaml to the final package...
Adding packages/jumpserver-1.0.tar.gz to the final package...
Adding yamls/ansible_jumpserver.yaml to the final package...
Adding packages/mirrors-1.0.tar.gz to the final package...
YAML file for ansible_mirrors does not exist.
Adding packages/n9e-1.0.tar.gz to the final package...
Adding yamls/ansible_n9e.yaml to the final package...
Adding packages/ntp-1.0.tar.gz to the final package...
Adding yamls/ansible_ntp.yaml to the final package...
Adding packages/openldap-1.0.tar.gz to the final package...
Adding yamls/ansible_openldap.yaml to the final package...
Adding packages/opensearch-1.0.tar.gz to the final package...
Adding yamls/ansible_opensearch.yaml to the final package...
Adding packages/repos-1.0.tar.gz to the final package...
Adding yamls/ansible_repos.yaml to the final package...
Adding packages/zabbix-1.0.tar.gz to the final package...
Adding yamls/ansible_zabbix.yaml to the final package...
Adding env.conf and install.sh to the final package...
Created final_packages/pd-20241018132459.tar.gz.gz
############################################################
查看包的大小，传到服务器上看包的大小
```

## 做出服务的包之后进行传包

```sh
ssh 10.142.101.12
###报错###
[root@HOST-10-142-48-169 final_packages]# ssh 10.142.101.12
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:5hJagOjw6357Wvy6oenrqqA/CK3Q9CpYdW+p0yUAXYM.
Please contact your system administrator.
Add correct host key in /root/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /root/.ssh/known_hosts:3
ECDSA host key for 10.142.101.12 has changed and you have requested strict checking.
Host key verification failed.
之后执行：
scp -o StrictHostKeyChecking=no /data1/data/pd/final_packages/pd-20241018132459.tar.gz root@10.142.101.12:/tmp/kou
```

## 之后执行解压服务包：

```bash
[root@localhost kou]# ls -lh
total 43G
-rw-r----- 1 root root 40G Oct 18 16:20 pd-20241018132459.tar.gz
[root@localhost kou]# tar -xvf pd-20241018132459.tar.gz -C /var/kou/
packages/ansible_rpm-1.0.tar.gz
yamls/ansible_ansible_rpm.yaml
packages/bind9-1.0.tar.gz
yamls/ansible_bind9.yaml
packages/containerd-1.0.tar.gz
yamls/ansible_containerd.yaml
packages/dcos-1.0.tar.gz
yamls/ansible_dcos.yaml
packages/jumpserver-1.0.tar.gz
yamls/ansible_jumpserver.yaml
packages/mirrors-1.0.tar.gz
tar: Unexpected EOF in archive
tar: rmtlseek not stopped at a record boundary
tar: Error is not recoverable: exiting now
###包的数据有可能有问题。需要到源机器解压是一次，包没问题，但是传输有问题，重新传包
重新解压
[root@HOST-10-142-48-169 final_packages]# tar -xvf pd-20241018132459.tar.gz
packages/ansible_rpm-1.0.tar.gz
yamls/ansible_ansible_rpm.yaml
packages/bind9-1.0.tar.gz
yamls/ansible_bind9.yaml
packages/containerd-1.0.tar.gz
yamls/ansible_containerd.yaml
packages/dcos-1.0.tar.gz
yamls/ansible_dcos.yaml
packages/jumpserver-1.0.tar.gz
yamls/ansible_jumpserver.yaml
packages/mirrors-1.0.tar.gz
packages/n9e-1.0.tar.gz
yamls/ansible_n9e.yaml
packages/ntp-1.0.tar.gz
yamls/ansible_ntp.yaml
packages/openldap-1.0.tar.gz
yamls/ansible_openldap.yaml
packages/opensearch-1.0.tar.gz
yamls/ansible_opensearch.yaml
packages/repos-1.0.tar.gz
yamls/ansible_repos.yaml
packages/zabbix-1.0.tar.gz
yamls/ansible_zabbix.yaml
env.conf
install.sh
yamls/hosts
yamls/env_vars.yaml

zabbix没有做总体的打包服务，需要单独打包
```

## 修改环境信息

``` 
[root@localhost kou]# cat env.conf 
#!/bin/bash


LOCAL_IP="10.142.101.12"      #机器IP
COBBLER_DHCP_IP_NETWORK="10.142.101.0"
COBBLER_DHCP_IP_NETMASK="255.255.255.0"
COBBLER_DHCP_IP_ROUTER="10.142.101.1"
COBBLER_DHCP_IP_RANGE="10.142.101.13 10.142.101.18"

[root@localhost kou]# vim yamls/hosts
[nodes]
10.142.101.11 
10.142.101.12     ###更改你要安装的IP
10.142.101.14

[localhost]
localhost ansible_connection=local

[all:vars]
ansible_ssh_pass=Goodsense@123
ansible_ssh_user=root
ansible_ssh_common_args='-o StrictHostKeyChecking=no'



[root@localhost kou]# cat yamls/env_vars.yaml 
--- 
# 3个节点的IP地址     #更改你要安装服务的机器（不是重装机器的ip）
node1: 10.142.101.11
node2: 10.142.101.12
node3: 10.142.101.14

# 基础服务的安装目录
base_dir: /tmp/pd   #需确认目录的大小，需要写解压的目录

ansible_rpm_version: "1.0"
bind9_version: "1.0"
containerd_version: "1.0"
dcos_version: "1.0"
jumpserver_version: "1.0"
n9e_version: "1.0"
ntp_version: "1.0"
openldap_version: "1.0"
opensearch_version: "1.0"
repos_version: "1.0"
zabbix_version: "1.0"


[root@localhost kou]# ls
env.conf  install.sh  packages  pd-20241018132459.tar.gz  yamls
```

![image-20241021141443640](C:\Users\koucs.vendor\AppData\Roaming\Typora\typora-user-images\image-20241021141443640.png)

![image-20241021150540315](C:\Users\koucs.vendor\AppData\Roaming\Typora\typora-user-images\image-20241021150540315.png)

**问题：**不弄LLD 那直接输入IP 下边的子网掩码都不存在，需要手动改该

![image-20241023110040191](C:\Users\koucs.vendor\AppData\Roaming\Typora\typora-user-images\image-20241023110040191.png)

# 可能碰见的问题

**1.打包服务的时候可能没有全部把服务都打包完成，需要手动看一下 tar -tzvf   xxx.tar.gz**

**2.传包的时候可能传过去的包大小不正确  ls -lh**

**3.界面dcos 报网络错误 ** 

```bash
vim ./dcos/config/dcos/backend/etc_dcos/prod.py
里面的openldap改成dcos-openldap
```

